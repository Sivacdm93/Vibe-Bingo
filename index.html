<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vibe_Bingo — Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .grid-cell{user-select:none}
    .grid-cell.fixed{cursor:not-allowed}
    .grid-cell.marked{outline:3px solid}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="max-w-6xl mx-auto p-4 space-y-6">
  <header class="flex items-center justify-between">
    <h1 class="text-2xl font-bold">Vibe_Bingo — Player</h1>
    <a href="admin.html" class="text-sm underline">Admin</a>
  </header>

  <div id="joining" class="space-y-4 bg-white p-4 rounded-2xl shadow">
    <h2 class="text-xl font-semibold">Join Game</h2>
    <div class="grid gap-3 md:grid-cols-2">
      <label class="block">Name
        <input id="name" class="w-full border rounded px-3 py-2" maxlength="30" placeholder="Your name" />
      </label>
      <label class="block">Avatar (optional)
        <input id="avatar" type="file" accept="image/*" class="w-full border rounded px-3 py-2" />
      </label>
    </div>
    <button id="joinBtn" class="px-4 py-2 rounded-xl bg-black text-white">Next</button>
  </div>

  <div id="themePick" class="hidden space-y-3 bg-white p-4 rounded-2xl shadow">
    <h2 class="text-xl font-semibold">Choose Theme</h2>
    <p class="text-sm text-gray-600">Admin controls which themes are available when the game is initiated.</p>
    <div id="themeList" class="flex gap-2 flex-wrap"></div>
  </div>

  <div id="boardStage" class="hidden bg-white p-4 rounded-2xl shadow space-y-4">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold">Your Board</h2>
      <div class="space-x-2">
        <button id="shuffleBtn" class="px-3 py-1 rounded bg-gray-800 text-white">Shuffle</button>
        <button id="fixBtn" class="px-3 py-1 rounded bg-emerald-600 text-white">Fix</button>
      </div>
    </div>
    <div id="board" class="grid grid-cols-5 gap-2"></div>
    <p id="boardHint" class="text-sm text-gray-600">Shuffle until you like it, then Fix to lock.</p>
  </div>

  <div id="playStage" class="hidden bg-white p-4 rounded-2xl shadow space-y-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-semibold">Play</h2>
        <p class="text-sm text-gray-600">Click the matching cell for each call. Speed earns more points.</p>
      </div>
      <div>
        <span class="text-sm">Theme: </span><span id="activeThemeName" class="font-medium"></span>
      </div>
    </div>

    <div class="p-3 border rounded-xl">
      <div class="text-sm text-gray-600">Current Call</div>
      <div id="currentCall" class="text-2xl font-bold py-2">—</div>
    </div>

    <div id="playBoard" class="grid grid-cols-5 gap-2"></div>

    <div class="grid md:grid-cols-3 gap-3">
      <div class="p-3 rounded-xl border">
        <div class="text-sm text-gray-600">Your Points</div>
        <div id="myPoints" class="text-2xl font-bold">0</div>
      </div>
      <div class="p-3 rounded-xl border">
        <div class="text-sm text-gray-600">Lines Completed</div>
        <div id="myLines" class="text-2xl font-bold">0</div>
      </div>
      <div class="p-3 rounded-xl border">
        <div class="text-sm text-gray-600">Your Status</div>
        <div id="myStatus" class="text-lg">Waiting…</div>
      </div>
    </div>
  </div>

  <div id="leaderStage" class="hidden bg-white p-4 rounded-2xl shadow">
    <h2 class="text-xl font-semibold">Leaderboard (Live)</h2>
    <ol id="leaderboard" class="mt-2 space-y-1"></ol>
    <div id="top3" class="mt-3 text-sm"></div>
  </div>
</div>

<script>
  // ==== CONFIG (fill these) ====
  const SUPABASE_URL = "https://ufklbzjspglhwnvfntzy.supabase.co";         // TODO: replace
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVma2xiempzcGdsaHdudmZudHp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjYxMTIsImV4cCI6MjA3NjAwMjExMn0.IlcHH6aVVYr0vtMZpFZnkUGi3iUlil3TYwekX16VIds";                       // TODO: replace
  const GAME_CODE = "Vibe_Bingo";                                  // event code

  // =============================
  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let game = null, me = null, myTheme = null, allowedThemes = [], activeTheme = null;
  let currentCall = null; // {id, item, call_at}

  const el = (id)=>document.getElementById(id);
  const joinBox = el('joining');
  const themeBox = el('themePick');
  const boardStage = el('boardStage');
  const playStage = el('playStage');
  const leaderStage = el('leaderStage');

  const nameInput = el('name');
  const avatarInput = el('avatar');

  const themeList = el('themeList');
  const boardDiv = el('board');
  const shuffleBtn = el('shuffleBtn');
  const fixBtn = el('fixBtn');

  const activeThemeName = el('activeThemeName');
  const currentCallDiv = el('currentCall');
  const playBoardDiv = el('playBoard');
  const myPointsDiv = el('myPoints');
  const myLinesDiv = el('myLines');
  const myStatusDiv = el('myStatus');
  const leaderboardOl = el('leaderboard');
  const top3Div = el('top3');

  function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
  function gridRender(container, items, marks=[], locked=false){
    container.innerHTML='';
    items.forEach((txt, i)=>{
      const cell=document.createElement('button');
      cell.className='grid-cell border rounded-xl p-3 text-sm bg-white hover:bg-gray-50';
      cell.textContent=txt;
      if(marks[i]) cell.classList.add('marked');
      if(locked) cell.classList.add('fixed');
      container.appendChild(cell);
    });
  }

  async function dataUrlFromFile(file){
    return new Promise((res,rej)=>{const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);});
  }

  async function ensureGame(){
    const { data } = await sb.from('games').select('*').eq('code', GAME_CODE).maybeSingle();
    if(!data){
      alert('Game not found. Ask admin to create it on admin page.');
      return null;
    }
    game = data;
    return game;
  }

  async function refreshAllowedThemes(){
    if(!game) return;
    const { data } = await sb.from('game_themes')
      .select('theme:themes(*)')
      .eq('game_id', game.id);
    const list = (data||[]).map(r=>r.theme);
    themeList.innerHTML='';
    list.forEach(t=>{
      const b=document.createElement('button');
      b.className='px-3 py-2 rounded-xl border';
      b.textContent=t.name;
      b.onclick=()=> pickTheme(t);
      themeList.appendChild(b);
    });
  }

  async function pickTheme(t){
    myTheme = t;
    themeBox.classList.add('hidden');
    boardStage.classList.remove('hidden');
    const pool = t.items.slice(0);
    const board = shuffle(pool).slice(0,25);
    me.board = board;
    me.marks = Array(25).fill(false);
    await sb.from('players').update({ theme_id:t.id, board:board, marks:me.marks, fixed:false }).eq('id', me.id);
    renderBoard();
  }

  function renderBoard(){
    gridRender(boardDiv, me.board, me.marks, me.fixed);
  }
  function renderPlayBoard(){
    gridRender(playBoardDiv, me.board, me.marks, true);
    [...playBoardDiv.children].forEach((btn, idx)=>{
      btn.onclick = async ()=>{
        if(!currentCall || me.bingo) return;
        if(me.fixed !== true){ alert('You must Fix your board before playing.'); return; }
        const matches = me.board[idx] === currentCall.item;
        if(!matches){ return; }
        if(me.marks[idx]){ return; }
        me.marks[idx] = true;
        btn.classList.add('marked');
        await sb.from('marks').insert({ game_id: game.id, player_id: me.id, call_id: currentCall.id, cell_index: idx });
        await sb.from('players').update({ marks: me.marks }).eq('id', me.id);
        recomputeLinesAndMaybeBingo();
      }
    });
  }

  function countLines(marks){
    const lines=[];
    for(let r=0;r<5;r++){ lines.push([0,1,2,3,4].map(c=>r*5+c)); }
    for(let c=0;c<5;c++){ lines.push([0,1,2,3,4].map(r=>r*5+c)); }
    lines.push([0,6,12,18,24]);
    lines.push([4,8,12,16,20]);
    let completed=0; let best=0;
    for(const L of lines){
      const cnt = L.reduce((a,i)=>a+(marks[i]?1:0),0);
      if(cnt===5) completed++;
      if(cnt>best) best=cnt;
    }
    return {completed, best};
  }

  async function recomputeLinesAndMaybeBingo(){
    const {completed} = countLines(me.marks);
    me.lines_completed = completed;
    myLinesDiv.textContent = completed;
    await sb.from('players').update({ lines_completed: completed }).eq('id', me.id);

    if(!me.bingo && completed>=1){
      me.bingo = true;
      await sb.from('players').update({ bingo: true }).eq('id', me.id);
    }
  }

  document.getElementById('joinBtn').onclick = async ()=>{
    if(!nameInput.value.trim()){ alert('Enter your name'); return; }
    await ensureGame(); if(!game) return;
    let avatarData = null;
    if(avatarInput.files && avatarInput.files[0]){
      avatarData = await dataUrlFromFile(avatarInput.files[0]);
    }
    let pid = localStorage.getItem('bingo_player_id');
    if(pid){
      const { data: p } = await sb.from('players').select('*').eq('id', pid).maybeSingle();
      if(p){ me=p; }
    }
    if(!me){
      const { data: p, error } = await sb.from('players').insert({
        game_id: game.id,
        name: nameInput.value.trim(),
        avatar: avatarData
      }).select().single();
      if(error){ alert(error.message); return; }
      me=p; localStorage.setItem('bingo_player_id', me.id);
    } else {
      const { data: p } = await sb.from('players').update({ name:nameInput.value.trim(), avatar: avatarData }).eq('id', me.id).select().single();
      me=p;
    }
    joinBox.classList.add('hidden');
    themeBox.classList.remove('hidden');
    await refreshAllowedThemes();
  };

  document.getElementById('shuffleBtn').onclick = async ()=>{
    if(!myTheme){ alert('Pick a theme first'); return; }
    if(me.fixed){ return; }
    me.board = shuffle(myTheme.items).slice(0,25);
    me.marks = Array(25).fill(false);
    await sb.from('players').update({ board: me.board, marks: me.marks }).eq('id', me.id);
    renderBoard();
  };
  document.getElementById('fixBtn').onclick = async ()=>{
    if(!myTheme){ alert('Pick a theme first'); return; }
    me.fixed = true;
    await sb.from('players').update({ fixed: true }).eq('id', me.id);
    boardStage.classList.add('hidden');
    playStage.classList.remove('hidden');
    renderPlayBoard();
  };

  (async function init(){
    await ensureGame();
    if(!game) return;

    sb.channel('game-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'games', filter: 'id=eq.'+ (game ? game.id : '') }, async (payload)=>{
        game = payload.new;
        if(game.status==='initiated'){ themeBox.classList.remove('hidden'); boardStage.classList.add('hidden'); playStage.classList.add('hidden'); await refreshAllowedThemes(); }
        if(game.status==='started'){ const { data: t } = await sb.from('themes').select('*').eq('id', game.active_theme).single(); activeThemeName.textContent = t ? t.name : '—'; playStage.classList.remove('hidden'); if(me && !me.fixed){ myStatusDiv.textContent = 'Please Fix your board to play'; } }
        if(game.status==='ended'){ myStatusDiv.textContent = 'Game Ended'; }
        const W = JSON.parse(game.winners||'[]');
        top3Div.textContent = W.map(w=>`${w.rank}. ${w.name}`).join('  ·  ');
      })
      .subscribe();

    sb.channel('call-changes')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'calls', filter: 'game_id=eq.'+ (game ? game.id : '') }, (payload)=>{
        currentCall = payload.new;
        currentCallDiv.textContent = currentCall.item;
        myStatusDiv.textContent = 'Awaiting your click…';
      })
      .subscribe();

    sb.channel('players-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'players', filter: 'game_id=eq.'+ (game ? game.id : '') }, async ()=>{
        const { data: ps } = await sb.from('players').select('id,name,points,lines_completed,bingo').eq('game_id', game.id);
        const sorted = (ps||[]).sort((a,b)=>{ if(b.lines_completed!==a.lines_completed) return b.lines_completed-a.lines_completed; if(b.points!==a.points) return b.points-a.points; return a.name.localeCompare(b.name); });
        leaderboardOl.innerHTML='';
        sorted.forEach((p,i)=>{
          const li=document.createElement('li');
          li.textContent = `${i+1}. ${p.name} — lines:${p.lines_completed}  points:${p.points}` + (p.bingo?' ✅':'');
          leaderboardOl.appendChild(li);
        });
        leaderStage.classList.remove('hidden');
      })
      .subscribe();

  })();

  sb.channel('marks-scoring')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'marks' }, async (payload)=>{
      const mk = payload.new;
      if(!game || mk.game_id!== (game ? game.id : null)) return;
      if(me && mk.player_id===me.id){
        const { data: c } = await sb.from('calls').select('*').eq('id', mk.call_id).single();
        const call_ts = new Date(c.call_at).getTime();
        const now_ts = Date.now();
        const latency_ms = Math.max(0, now_ts - call_ts);
        const pts = Math.max(5, Math.round(100 - (90 * Math.min(latency_ms, 5000) / 5000)));
        me.points = (me.points||0) + pts;
        myPointsDiv.textContent = me.points;
        await sb.from('players').update({ points: me.points }).eq('id', me.id);
        const { completed } = countLines(me.marks);
        if(completed>=1 && !me.bingo){ me.bingo=true; await sb.from('players').update({ bingo:true }).eq('id', me.id); }
        myStatusDiv.textContent = `Marked +${pts} pts`;
      }
    })
    .subscribe();
</script>
</body>
</html>
